<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cycle Management</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="../bootstrap3/js/holder.js"></script>
  <script src="../bootstrap3/jquery-1.9.1.min.js"></script>
  <script src="../bootstrap3/js/bootstrap.js"></script>

  <!-- FONTS LINK HERE -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap">

  <!-- CSS LINK HERE -->
  <link href="../bootstrap3/css/header.css" rel="stylesheet" type="text/css"> <!-- Header -->
  <link href="css/createCycle.css" rel="stylesheet" type="text/css"> <!-- Main -->

</head>
<body>
 <div class="top-div">
        <div class="top-text">
            <p>cyclic App</p>
        </div>
    </div>
  
<div class="tab-div">  
<div class="header"> 
  <div class="tab" > 
  <a class="link" href="userdata.html">User Info</a>
  </div>
  <div class="tab">
  <a class="link" href="projectmanagement.html">Project Management</a>
  </div>
  <div class="tab"> 
    <a class="link" href="createcycle.html">Cycle Management</a>
  </div>
</div></br>
</div>

<form id="form-create-cycle" action="createcycle.html" role="form">
  <div class="cycleDiv">
    <label for="cycleName" class="cycleName_Label">Create Cycle Name </label>
    <input name="cycleName" type="text" id="cycleName" class="cycleName_Input" placeholder="Enter Cycle Name Here ">
    <input id="btn-create-cycle" type="button" value="Create" class="cycleCreateButton"/>
  </div>
</form></br>

<div class="boxCycles" id="myCycles">
  
</div></br></br>
  <div class="centered-container">
  <button class='addEvent_Button' onclick='addEvent()'> Create Event</button></br>
  </div>
<div id="createEventDiv" style="display: none;">
  <form id="form-create-event" action="createcycle.html" role="form">
    <div class="createEventDiv">
      <label for="createEventName" class="createEventName_Label">Event name </label>
      <input name="createEventName" type="text" id="createEventName" class="createEventName_Input">
      <label for="createEventActionable" class="createEventActionable_Label">Actionable </label>
      <input type="checkbox" id="createEventActionable" name="createEventActionable" value="actionable">
      <input id="btn-create-event" type="submit" value="create" class="eventCreateButton" onclick="createEventOnCycle()"/>
    </div>
  </form>
</div>
</br></br></br>
  
<div class="myEventDiv" id="myEventsDiv">
  
</div></br>

<script type="text/javascript">
  /*  add note function
   *  desc: use to add note to cycle within cycle boxes
  */
  // =============================================================
  function addNote(cycleId) {
      location.href = "addnote.html?cycleId=" + cycleId;
  }
  // =============================================================
  

  /*  add note function2
   *  desc: use to add note to event within event boxes
  */
  // =============================================================
  function addNote2(eventId) {
      location.href = "addnote.html?eventId=" + eventId;
  }
  // =============================================================

  
  ///CREATE CYCLE BUTTON
  $("#btn-create-cycle").click(function() {
    let cycle_Name = document.getElementById("cycleName").value;
    $.ajax({
      ///AJAX WILL PROCESS
      url: "/cycles/insert_cycle",
      type: "POST",
      data: $("#form-create-cycle").serialize(),
      dataType: "JSON",
      success: function(json) {
        if (json.state == 200) {
          alert("create cycle success");
          location.reload();
        } else {
          alert("create cycle fail");
        }
      },
      error: function(xhr) {
        alert("error" + xhr.message);
      }
    });
  });

  let pArray = [];
  $.ajax({
    url: "/projects/get_projectids",
    type: "GET",
    dataType: "json",
    success: function(response) {
      var pLength = Object.keys(response.data).length;

      for (var i = 0; i < pLength; i++) {
        pArray[i] = Object.values(response.data)[i];
        ///console.log(pArray[i]);
      }
    },
    error: function(xhr, status, error) {
      console.log(error);
    }
  });

  function insertEventsCycle(cid, eid) {
      $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/cycles/add_event?cycleId=" + cid + "&eventId=" + eid,
      type: "GET",
      dataType: "json",
      success: function(response) {
        console.log("Success");
        location.reload();
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
    }


  function displayEvent(eid, cid) {
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/events/get_event?eventId=" + eid,
      type: "GET",
      dataType: "json",
      success: function(response) {
        let data = response.data;
        let string = JSON.stringify(data);
        let events = Object.values(data);
        console.log(string);
        console.log("#cycle_events_" + cid);
        $("#cycle_events_" + cid).append("<div class='eventDiv' id='event_" + events[1] + "'>Event Name: " + events[2] + " " + "</div>");
        
        console.log("Success");
        if (events[0] == 1)
        {
          $("#event_" + events[1]).append("<input type='checkbox' id='event_" + events[1] + "_isactionable' name='isActionable' value='actionable'></br>");
        }
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
  }
  function deleteEvent(eid) {
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/events/delete_event?eventId=" + eid,
      type: "GET",
      dataType: "json",
      success: function(response) {
        alert("success");
        location.reload();
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
  }
  function getEventID(cid) {
    let eid;
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/cycles/get_event_ids?cycleId=" + cid,
      type: "GET",
      dataType: "json",
      success: function(response) {
        let eventData = response.data;
        let eventLength = Object.keys(eventData).length;
        if (eventLength > 0) {
          let eventString = JSON.stringify(eventData);
          eid = eventString;
          console.log("Stringify: " + eid);
          for (var i = 0; i < eventLength; i++) {
            console.log("Array: " + Object.values(eventData)[i]);
            displayEvent(Object.values(eventData)[i], cid);
          }
        }
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
  }

  function addToProject(pid, cid) {
        ///ADD CYCLE TO PROJECT FUNCTION
        $.ajax({
          url: "/projects/add_cycle?projectId=" + pid + "&cycleId=" + cid,
          type: "POST",
          dataType: "JSON",
          success: function(json) {
            if (json.state == 200) {
              alert("success");
            } else {
              alert("fail");
            }
          },
          error: function(xhr) {
            alert("error" + xhr.message);
          }
        });
      }
function addEvent() {
    ///$("#addEventDiv_" + cid).append("THIS SHOWS SOMETHING, CYCLE ID: " + cid);
    let displayDiv = document.getElementById("createEventDiv");
    displayDiv.style.display = "flex";
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/cycles/",
      type: "GET",
      dataType: "json",
      success: function(response) {
        let cData = response.data;
        let cString = JSON.stringify(cData);
        let cLength = Object.keys(cData).length;
        for (var i = 0; i < cLength; i++) {
          var selectElement = document.getElementById("createEventCycleName");
          var option = document.createElement("option");
          let cycleName = Object.values(cData[i])[1];
          let cycleId = Object.values(cData[i])[0];
          console.log(cycleName);
          option.text = cycleName;
          option.value = cycleId;
          selectElement.add(option);
        }
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
  }
    
  function createEventOnCycle() {
    let eventName = document.getElementById("createEventName").value;
    let actionable = document.getElementById("createEventActionable");
    let form = document.getElementById("form-create-event");
    form.addEventListener("submit", function(event) {
      event.preventDefault();
      const integerValue = actionable.checked ? 1 : 0;
      console.log(cycleName + " " + eventName + "Checkbox Value (integer):", integerValue);
      $.ajax({
        url: "/events/insert_event?eventName=" + eventName + "&actionable=" + integerValue,
        type: "POST",
        dataType: "JSON",
        success: function(json) {
          if (json.state == 200) {
            alert("success");
          } else {
            alert("fail");
          }
        },
        error: function(xhr) {
          alert("error" + xhr.message);
        }
      });
    });
  }
  
  $(document).ready(function() {
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/cycles/get_cycles_by_uid",
      type: "GET",
      dataType: "json",
      success: function(response) {
        let cArray = [];
        let cData = response.data;
        let cString = JSON.stringify(cData);
        let cLength = Object.keys(cData).length;
        console.log(cString);
        for (var i = 0; i < cLength; i++) {
          let cycleData = "Cycle Name: " + Object.values(cData[i])[1] + " | Start Date: " + Object.values(cData[i])[2] + " | End Date: " + Object.values(cData[i])[3];
          cArray[i] = Object.values(cData[i])[0];
          getEventID(Object.values(cData[i])[0]);
          $("#myCycles").append("<div class='myCycles' id='myCycle" + Object.values(cData[i])[0] + "'>" + cycleData + " </div></br>");
          $("#myCycle" + Object.values(cData[i])[0]).append("<div id='addEventDiv_" + Object.values(cData[i])[0] + "'></div>");
          
          // ===================== add note button ==========================
          $("#myCycle" + Object.values(cData[i])[0]).append("<button class='addNoteButton' onclick='addNote(" + Object.values(cData[i])[0] + ")'>Add Note</button>");
          // ================================================================
          
          $("#myCycle" + Object.values(cData[i])[0]).append("<div id='cycle_events_" + Object.values(cData[i])[0] + "' class='cycle_events'></div>");
          for (var j = 0; j < pArray.length; j++) {
            $("#myCycle" + Object.values(cData[i])[0]).append("<button class='myCycles_Button' onclick='addToProject(" + pArray[j] + "," + Object.values(cData[i])[0] + ")'>+ Add to Project " + pArray[j] + "</button>&nbsp");
          }
        }
        getEventByUID(cArray);
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });

    function getEventByUID(cArray) {
    $.ajax({
      url: "https://murdoch-2023-ict302-ft1-cyclicapp.up.railway.app/events/get_event_by_uid",
      type: "GET",
      dataType: "json",
      success: function(response) {
        let eArray = [];
        let eData = response.data;
        let eString = JSON.stringify(eData);
        let eLength = Object.keys(eData).length;
        console.log(eString);
        for (var i = 0; i < eLength; i++) {
          eArray[i] = Object.values(eData[i])[1];
          let eventData = "Event Name: " + Object.values(eData[i])[2];
          $("#myEventsDiv").append("<div id='eventsDiv_" + Object.values(eData[i])[1] + "'>" + eventData + "</div></br>");
          

          
          console.log(eventData);
          console.log(cArray.length);
          for (var j = 0; j < cArray.length; j++) {
            $("#eventsDiv_" + Object.values(eData[i])[1]).append("<br><br><button class='myEvents_button' onclick='insertEventsCycle(" + cArray[j] + "," + Object.values(eData[i])[1] + ")'>+ Add to Cycle " + cArray[j] + "</button>");
           
          }
           $("#eventsDiv_" + Object.values(eData[i])[1]).append("</br><br><button class='deleteEvent_" + Object.values(eData[i])[1] + "' onclick='deleteEvent(" + Object.values(eData[i])[1] + ")'>Delete Event</button>");
        }
            // ===================== add note button ==========================
            $("#myEventsDiv" + Object.values(eData[i])[1]).append("<button class='addNoteButton' onclick='addNote2(" + Object.values(eData[i])[1] + ")'>Add Note</button>");
            // ================================================================
      },
      error: function(xhr, status, error) {
        console.log(error);
      }
    });
    }
  });
</script>
</body>
</html>
